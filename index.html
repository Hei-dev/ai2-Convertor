<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
    </head>
    <body>
        <a href="https://github.com/Hei-dev/ai2-Convertor">Help</a>
        <input type="file" id="cFile">

        <label id="lbl"></label>

        <div id="logs"></div>

        <div id="save"></div>
        ---------------------------------
        <h3>Sample HTML</h3>
        <div id="prev"></div>

        <script src="convertDict.js"></script>
        <script src="convertdictStyle.js"></script>
        <script src="convertDictExtra.js"></script>
        <script src="infos.js"></script>
        <script type="text/javascript">
        genExtra = function(d){ //Gen extra attributes such as src, onclick
            var extra = ''
            //console.log(d)
            for(var istr in ai2ext.Extra){
                console.log(istr in d)
                if(istr in d){
                    console.log(istr)
                    console.log(d[istr])
                    if(typeof ai2ext.Extra[istr].value!='string'){
                        extra += ai2ext.Extra[istr].id + ai2ext.Extra[istr].value[d[istr]] + ' '
                    }
                    else{
                        extra += ai2ext.Extra[istr].id + d[istr] + ai2ext.Extra[istr].value + ' '
                    }
                }
            }
            return extra
        }

        getStyle = function(d){ //d = component json data
            /*
                TODO Replace all the in statement with a loop
                which loop through all the keys
                and match them with the json file.
                (Only one 'in' statement is required)
                /\ /\Already Done/\ /\
                Note that is may or may not be the best method
                and is subject to change
            */
            var style = ''

            if((d.$Type == 'HorizontalScrollArrangement') || (d.$Type == 'HorizontalArrangement')){
                style = 'display:inline-flex'
            }
            if((d.$Type == 'VerticalScrollArrangement') || (d.$Type == 'VerticalArrangement')){
                style = 'display:block'
            }

            //console.log(d)
            for(var istr in ai2sty.Style){
                console.log(istr in d)
                if(istr in d){
                    //console.log(istr)
                    //console.log(d.TextAlignment)
                    //console.log(d[istr])
                    if(typeof ai2sty.Style[istr].value!='string'){
                        style += ai2sty.Style[istr].id + ai2sty.Style[istr].value[d[istr]] + ';'
                    }
                    else{
                        if(ai2sty.Style[istr].isColorHex) {
                            style += ai2sty.Style[istr].id + d[istr].replace("&HFF", "#") + ai2sty.Style[istr].value + ';'
                        } else {
                        style += ai2sty.Style[istr].id + d[istr] + ai2sty.Style[istr].value + ';'
                        }
                    }
                }
            }



            //No Style Check
            if(style != ''){
                style = 'style="' + style + '"';
            }
            return style
        }

        /**
         * Convert the ai2 object to a HTML Element 
         * @param d - the ai2 object  
         */
        getElement = function(d){ //TODO Change these to reference json file for dict on converting
            checkLog(d)
            if(d.$Type in ai2cmp.Tag){
                console.log(d.$Type)
                //console.log('is it' + d.$Type == 'HorizontalScrollArrangement')
                if(d.Text === undefined){
                    if((d.$Type == 'HorizontalScrollArrangement') || (d.$Type == 'HorizontalArrangement') || (d.$Type == 'VerticalScrollArrangement') || (d.$Type == 'VerticalArrangement')){
                        console.log(d.$Components)
                        var innerContent = ""
                        for(var j=0;j<d.$Components.length;j++){
                            innerContent += getElement(d.$Components[j]) //CONVERT PROCEDURE
                        }
                        return '<' + 'div' + ' id="' + d.$Name + '" ' + getStyle(d) + genExtra(d) + '>'
                            + innerContent + '</' + 'div' +'>\n<br>';
                    }
                    else{
                    return '<' + ai2cmp.Tag[d.$Type] + ' id="' + d.$Name + '" ' + getStyle(d) + genExtra(d) + '>'
                        + '</' + ai2cmp.Tag[d.$Type] +'>\n<br>';
                    }
                }
                else{
                    return '<' + ai2cmp.Tag[d.$Type] + ' id="' + d.$Name + '" ' + getStyle(d) + genExtra(d) + '>'
                        + d.Text + '</' + ai2cmp.Tag[d.$Type] +'>\n<br>';
                }
            }
            else{
                return ''
            }
            
        }


        function scmToHtml(obj){
            var hcode = "";
            hcode = '<html><head><meta charset="UTF-8"><title>'
                    + obj.AppName + '/' + obj.$Name
                    + '</title></head>\n<body>\n<div style="">'
            console.log(obj)
            for(var i=0;i<obj.$Components.length;i++){
                hcode += getElement(obj.$Components[i]) //CONVERT PROCEDURE
            }
            hcode += '</div></body></html>'
            console.log(hcode)
            document.getElementById('prev').innerHTML = hcode
            var htmlDoc = null
            var htmlDatas = new Blob([hcode], {type: 'text/plain'});
            if (hcode !== null) {
                window.URL.revokeObjectURL(htmlDoc);
            }
            document.getElementById("save").innerHTML = "<a style='font-size:30vm'"
                + " href=\"" + window.URL.createObjectURL(htmlDatas)
                + "\" download='" + obj.$Name + ".html'>Download HTML File</a>";
        }


        var scn;
            document.getElementById("cFile").addEventListener("change",function(e){
                var f = new FileReader();
                
                f.onload = function(){
                    //console.log("fbh");
                    var tScm = f.result.split("\n");
                    try{
                        scn = JSON.parse(tScm[2]);
                        console.log(scn);
                        scmToHtml(scn.Properties)
                    }
                    catch(err){
                        console.log(err)
                    }
                    
                }
                f.readAsText(e.target.files[0]);
            });
        </script>
    </body>
</html>
